// EXPECTED_OUTPUT: Starting worker...
// EXPECTED_OUTPUT: Worker 1: loop 0
// EXPECTED_OUTPUT: Worker 2: loop 0
// EXPECTED_OUTPUT: Waiting for worker 1...
// EXPECTED_OUTPUT: Worker 1: added 0
// EXPECTED_OUTPUT: Worker 2: added 0
// EXPECTED_OUTPUT: Worker 1: loop 1
// EXPECTED_OUTPUT: Worker2 1: loop 0
// EXPECTED_OUTPUT: Worker 2: loop 1
// EXPECTED_OUTPUT: Worker2 2: loop 0
// EXPECTED_OUTPUT: Worker 1: added 1
// EXPECTED_OUTPUT: Worker 2: added 1
// EXPECTED_OUTPUT: Worker 1: loop 2
// EXPECTED_OUTPUT: Worker2 1: loop 0
// EXPECTED_OUTPUT: Worker2 1: loop 1
// EXPECTED_OUTPUT: Worker 1: added 3
// EXPECTED_OUTPUT: Worker 1 result: 4
// EXPECTED_OUTPUT: Waiting for worker 2...
// EXPECTED_OUTPUT: Worker 2 result: 1
// EXPECTED_RESULT: 5

#include "std/io.eth"

i32 worker2(i32 id, i32 count) {
    i32 sum = 0;
    for (i32 i = 0; i < count; i++) {
        printf("Worker2 %d: loop %d\n", id, i);
        sum = sum + i + 1;
        yield;
    }
    return sum;
}

i32 worker(i32 id, i32 count) {
    i32 sum = 0;
    for (i32 i = 0; i < count; i++) {
        printf("Worker %d: loop %d\n", id, i);
        i32 to_add = await spawn worker2(id, i);
        printf("Worker %d: added %d\n", id, to_add);
        sum = sum + to_add;
        yield;
    }
    return sum;
}

i32 main() {
    printf("Starting worker...\n");
    coroutine(i32) h1 = spawn worker(1, 3);
    coroutine(i32) h2 = spawn worker(2, 2);

    printf("Waiting for worker 1...\n");
    i32 res1 = await h1;
    printf("Worker 1 result: %d\n", res1);

    printf("Waiting for worker 2...\n");
    i32 res2 = await h2;
    printf("Worker 2 result: %d\n", res2);

    return res1 + res2;
}
